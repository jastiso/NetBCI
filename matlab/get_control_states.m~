%% Get largest eigenvalue state
% get the "easiest to get to" state from the max and min
% also get the state associated with the smallest eigenvalue
% also get the easiest to reach for the second largest behavioral loading
% and get the state associated with the second largest eigenvalue
% Which channels are used for control: gradiometers:
%GRAD2
%'MEG0242';'MEG0232';'MEG0442';'MEG0432';'MEG0712';'MEG0742';'MEG1842';'MEG1822';'MEG1812';'MEG1622';'MEG1612';
%GRAD3
%'MEG0243';'MEG0233';'MEG0443';'MEG0433';'MEG0713';'MEG0743';'MEG1843';'MEG1823';'MEG1813';'MEG1623';'MEG1613';


addpath(genpath('/Users/stiso/Documents/MATLAB/npy-matlab-master/'))
addpath('/Users/stiso/Documents/MATLAB/fieldtrip-20170830/')
R_dir = '/Users/stiso/Documents/R/NetBCI/data/wpli/';

top_dir = '/Users/stiso/Documents/MATLAB/NetBCI/';
data_dir = '/Users/stiso/Documents/Python/NetBCI/NMF/param/';
save_dir = [top_dir, 'GroupAvg/wpli/analysis/'];
img_dir = [top_dir, 'GroupAvg/wpli/images/'];
% make directories
if ~exist(img_dir, 'dir')
    mkdir(img_dir)
end
% make directories
if ~exist(save_dir, 'dir')
    mkdir(save_dir)
end
% make directories
if ~exist(R_dir, 'dir')
    mkdir(R_dir)
end

% things for making control set
grad2 = ['MEG0242';'MEG0232';'MEG0442';'MEG0432';'MEG0712';'MEG0742';'MEG1842';'MEG1822';'MEG1812';'MEG1622';'MEG1612'];
grad3 = ['MEG0243';'MEG0233';'MEG0443';'MEG0433';'MEG0713';'MEG0743';'MEG1843';'MEG1823';'MEG1813';'MEG1623';'MEG1613'];

Subj = [1:20];
nSubj = numel(Subj);
freqs = [7,14;15,30;31,45;55,70];
bands = [{'alpha'}, {'beta'}, {'low_gamma'}];
sensors = [{'grad'}];
regions = [{'Left_frontal'}, {'Left_occipital'}, {'Left_parietal'}, {'Left_temporal'}, ...
    {'Right_frontal'}, {'Right_occipital'}, {'Right_parietal'}, {'Right_temporal'}, {'Vertex'}, {'Left_motor'}, {'Right_motor'}];
%regions = [{'Left_motor'}, {'Right_motor'}];


nNode = 102;
nEdges = (nNode^2-nNode)/2;
load([save_dir, 'noise_sg.mat']);

% initialize
high_states = zeros(nNode, nSubj, numel(bands));
high2_states = zeros(nNode, nSubj, numel(bands));
high2_states_ev2 = zeros(nNode, nSubj, numel(bands));
high2_states_ev3 = zeros(nNode, nSubj, numel(bands));
high3_states = zeros(nNode, nSubj, numel(bands));
high3_states_ev2 = zeros(nNode, nSubj, numel(bands));
high_states_ev2 = zeros(nNode, nSubj, numel(bands));
high3_states_ev3 = zeros(nNode, nSubj, numel(bands));
high_states_ev3 = zeros(nNode, nSubj, numel(bands));
low_states = zeros(nNode, nSubj, numel(bands));
low_states_ev2 = zeros(nNode, nSubj, numel(bands));
low_states_ev3 = zeros(nNode, nSubj, numel(bands));
small_states = zeros(nNode, nSubj, numel(bands));
zero_states = zeros(nNode, nSubj, numel(bands));
zero_states_ev2 = zeros(nNode, nSubj, numel(bands));
zero_states_ev3 = zeros(nNode, nSubj, numel(bands));

%% Make control set

% get labels
load(['/Users/stiso/Resilio Sync/NETBCI.RAW/DataBase/1_Signals/2_Segmentation/2_MEG/1_Signals/2_Segmentation/2_MEG/Session1/1_test01/Seg_MEG_Subj001_Ses1_test01.mat'])
labels = Seg_MEG_Subj001_Ses1_test01.MI.label;
load(['/Users/stiso/Resilio Sync/NETBCI.RAW/DataBase/1_Signals/0_RawData/2_MEG/Session1/1_test01/RawData_MEG_Subj001_Ses1_test01.mat'])
mag_idx = strcmp(RawData_MEG_Subj001_Ses1_test01.meg_sensors.chantype,'megmag');
grad_label = labels(~mag_idx);

cnt = 1;
cmb_labels = cell(nNode,1);
for i = 1:2:numel(grad_label)
    cmb_labels{cnt} = [grad_label{i}, '+', grad_label{i+1}(end-3:end)];
    cnt = cnt + 1;
end

load([top_dir, 'montages/Left_motor_idx.mat'])
B = idx;

% Get states for right temporal control state
nControl = sum(B);

% chosing right temporal
%load([top_dir, 'montages/Right_temporal_idx.mat'])
%B_control = idx;
%load([top_dir, 'montages/Right_occipital_idx.mat'])
% get two regions from occipital that are close
%B_control(97:98) = idx(97:98);
%B_control = double(B_control);
%sum(B_control)

% right motor seems like a stricter control
load([top_dir, 'montages/Right_motor_idx.mat'])
B_control = idx;

%% Loop through data

% this used to index over mag and grad, but we dont look at mag
sens = sensors{1};
R_dir_s = [R_dir, sens, '/'];

for i = Subj
    s_idx = find(i == Subj);
    subj = sprintf('%03d', i);
    
    for k = 1:numel(bands)
        f = bands{k};
        
        % get subgraph data
        if strcmp(data_dir(end-5:end-1),'param')
            subset = readNPY([data_dir, subj, '/', sens, 'wpli_', f, '_subset.npy']);
            coeff = readNPY([data_dir, subj, '/',sens, 'wpli_', f, '_coeff.npy']);
        else
            subset = readNPY([data_dir, subj, '/', sens, '/wpli_', f, '_subset.npy']);
            coeff = readNPY([data_dir, subj, '/',sens, '/wpli_', f, '_coeff.npy']);
        end
        
        % remove noise SG
        idx = noise_sg{k,i};
        coeff = coeff(~idx,:);
        subset = subset(~idx,:);
        
        b_exp = subset(:,end);
        [tmp,tmp_idx] = sort(b_exp,'descend');
        bSG = tmp_idx(1);
        bSG2 = tmp_idx(2); % second biggest element
        bSG3 = tmp_idx(3); % third biggest element
        [~, nzSG] = min(nonzeros((b_exp))); % smallest nonzero - this is how we will opporationalize "low"
        
        % if you actualy want to look at 0s
        if sum(b_exp == 0) <= 1
            [~,nbSG] = min(b_exp);
        else
            nbSG = find(b_exp == 0);
        end
        nZero = numel(nbSG);
        
        
        
        
        %get gramian
        % scale to be stable
        % 1st
        high_mat = get_sg_matrix(nNode, subset(bSG,:));
        high_mat = high_mat./eigs(high_mat,1) - eye(nNode).*1.001;
        %2nd
        high2_mat = get_sg_matrix(nNode, subset(bSG2,:));
        high2_mat = high2_mat./eigs(high2_mat,1) - eye(nNode).*1.001;
        %3rd
        high3_mat = get_sg_matrix(nNode, subset(bSG3,:));
        high3_mat = high3_mat./eigs(high3_mat,1) - eye(nNode).*1.001;
        %lowest
        low_mat = get_sg_matrix(nNode, subset(nzSG,:));
        low_mat = low_mat./eigs(low_mat,1) - eye(nNode).*1.001;
        zero_mat = zeros(nNode, nNode, nZero);
        for j = 1:nZero
            zero_mat(:,:,j) = get_sg_matrix(nNode, subset(nbSG,:));
            zero_mat(:,:,j) = zero_mat(:,:,j)./eigs(zero_mat(:,:,j),1) - eye(nNode).*1.001;
        end
        
        
        % get largest eigenvector of grammian
        [h_vect, ~, small_vect, vect2, vect3] = easy_state(high_mat,diag(B),eye(nNode),zeros(nNode));
        high_states(:,i,k) = h_vect;
        small_states(:,i,k) = small_vect;
        high_states_ev2(:,i,k) = vect2;
        high_states_ev3(:,i,k) = vect3;
        [h2_vect, ~, ~, h2_v2, h2_v3] = easy_state(high2_mat,diag(B),eye(nNode),zeros(nNode));
        high2_states(:,i,k) = h2_vect;
        high2_states_ev2(:,i,k) = h2_v2;
        high2_states_ev3(:,i,k) = h2_v3;
        [h3_vect, ~, ~, h3_v2, h3_v3] = easy_state(high3_mat,diag(B),eye(nNode),zeros(nNode));
        high3_states(:,i,k) = h3_vect;
        high3_states_ev2(:,i,k) = h3_v2;
        high3_states_ev3(:,i,k) = h3_v3;
        [l_vect, ~, ~, l_v2, l_v3] = easy_state(low_mat,diag(B),eye(nNode),zeros(nNode));
        low_states(:,i,k) = l_vect;
        low_states_ev2(:,i,k) = l_v2;
        low_states_ev3(:,i,k) = l_v3;

        z_vect_all = zeros(nNode, nZero);
        z_ev2_all = zeros(nNode, nZero);
        z_ev3_all = zeros(nNode, nZero);
        for j = 1:nZero
            [z_vect, ~, ~, z_ev2, z_ev3] = easy_state(zero_mat(:,:,j),diag(B),eye(nNode),zeros(nNode));
            z_vect_all(:,j) = z_vect;
            z_ev2_all(:,j) = z_ev2;
            z_ev3_all(:,j) = z_ev3;
        end
        zero_states(:,i,k) = mean(z_vect_all,2);
        zero_states_ev2(:,i,k) = mean(z_ev2_all,2);
        zero_states_ev3(:,i,k) = mean(z_ev3_all,2);
    end
end


%% visualize

cfg.layout = [top_dir, 'layouts/neuromag306cmb.lay'];

for i = 1:numel(bands)
    plot_data.powspctrm = mean(high_states(:,:,i),2);
    plot_data.label = cmb_labels;
    plot_data.dimord = 'chan_freq';
    plot_data.freq = mean(freqs(i,:));
    plot_data.cfg = [];
%     figure(1); clf
%     ft_topoplotER(cfg,plot_data); colorbar; caxis([0.06,.13])
%     saveas(gca, [img_dir, bands{i}, '_avg_high_state.png'], 'png')
%     
%     plot_data.powspctrm = mean(low_states(:,:,i),2);
%     figure(2); clf
%     ft_topoplotER(cfg,plot_data); colorbar; caxis([0.06,.13])
%     saveas(gca, [img_dir, bands{i}, '_avg_low_state.png'], 'png')
%     
%     plot_data.powspctrm = mean(small_states(:,:,i),2);
%     figure(3); clf
%     ft_topoplotER(cfg,plot_data); colorbar;
%     saveas(gca, [img_dir, bands{i}, '_avg_small_state.png'], 'png')
%     
%     plot_data.powspctrm = mean(high2_states(:,:,i),2);
%     figure(4); clf
%     ft_topoplotER(cfg,plot_data); colorbar; caxis([0.06,.13])
%     saveas(gca, [img_dir, bands{i}, '_avg_high2_state.png'], 'png')
%     
%     plot_data.powspctrm = mean(high3_states(:,:,i),2);
%     figure(5); clf
%     ft_topoplotER(cfg,plot_data); colorbar; caxis([0.06,.13])
%     saveas(gca, [img_dir, bands{i}, '_avg_high3_state.png'], 'png')
    
    plot_data.powspctrm = mean(high_states_ev2(:,:,i),2);
    figure(6); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_avg_high_ev2_state.png'], 'png')
    
    plot_data.powspctrm = mean(low_states_ev2(:,:,i),2);
    figure(7); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_avg_low_ev2_state.png'], 'png')
    
    plot_data.powspctrm = mean(zero_states(:,:,i),2);
    figure(8); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([0.06,.13])
    saveas(gca, [img_dir, bands{i}, '_avg_zero_state.png'], 'png')
    
    plot_data.powspctrm = mean(zero_states_ev2(:,:,i),2);
    figure(9); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_avg_zero_ev2_state.png'], 'png')
    
    plot_data.powspctrm = mean(high2_states_ev2(:,:,i),2);
    figure(10); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_avg_high2_ev2_state.png'], 'png')
    
    plot_data.powspctrm = mean(high3_states_ev2(:,:,i),2);
    figure(11); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_avg_high3_ev2_state.png'], 'png')  
end

%% Categorize by lobe


h_region = [];
l_region = [];
l_region2 = [];
h_region2 = [];
l_region3 = [];
h_region3 = [];
h2_region = [];
h3_region = [];
h2_region2 = [];
h3_region2 = [];
h2_region3 = [];
h3_region3 = [];
small_region = [];
z_region = [];
z_region2 = [];
z_region3 = [];
region_ord = {};
band_ord = {};

cnt = 1;
for i = 1:numel(regions)
    for j = 1:numel(bands)
        load([top_dir, 'montages/', regions{i}, '_idx.mat'])
        idx = logical(idx);
        % get the mean edge between a lobes (total edges/number of edges), divided by
        % the total edges
        
        % stupid frmatting thing for R
        for k = 0:19
            region_ord{cnt+k} = regions{i};
            band_ord{cnt+k} = bands{j};
        end
        h_region = [h_region, mean(high_states(idx,:,j))];
        l_region = [l_region, mean(low_states(idx,:,j))];
        h2_region = [h2_region, mean(high2_states(idx,:,j))];
        h3_region = [h3_region, mean(high3_states(idx,:,j))];
        h2_region2 = [h2_region2, mean(high2_states_ev2(idx,:,j))];
        h3_region2 = [h3_region2, mean(high3_states_ev2(idx,:,j))];
        h2_region3 = [h2_region3, mean(high2_states_ev3(idx,:,j))];
        h3_region3 = [h3_region3, mean(high3_states_ev3(idx,:,j))];
        h_region2 = [h_region2, mean(high_states_ev2(idx,:,j))];
        l_region2 = [l_region2, mean(low_states_ev2(idx,:,j))];
        h_region3 = [h_region3, mean(high_states_ev3(idx,:,j))];
        l_region3 = [l_region3, mean(low_states_ev3(idx,:,j))];
        z_region = [z_region, mean(zero_states(idx,:,j))];
        z_region2 = [z_region2, mean(zero_states_ev2(idx,:,j))];
        z_region3 = [z_region3, mean(zero_states_ev3(idx,:,j))];
        small_region = [small_region, mean(small_states(idx,:,j))];
        cnt = cnt + nSubj;
    end
end

save([R_dir, 'grad/control_state.mat'], 'region_ord', 'band_ord', 'h_region', 'l_region', 'h2_region', 'h3_region', 'h_region2', 'l_region2', ...
    'z_region', 'z_region2', 'small_region', 'h2_region2', 'h3_region2')



%% Other control set - Loop through data --------------------------------

cont_high_states = zeros(nNode, nSubj, numel(bands));
cont_high_states_ev2 = zeros(nNode, nSubj, numel(bands));
cont_low_states = zeros(nNode, nSubj, numel(bands));
cont_low_states_ev2 = zeros(nNode, nSubj, numel(bands));
cont_zero_states_ev2 = zeros(nNode, nSubj, numel(bands));

sens = sensors{1};
R_dir_s = [R_dir, sens, '/'];

for i = Subj
    s_idx = find(i == Subj);
    subj = sprintf('%03d', i);
    
    for k = 1:numel(bands)
        f = bands{k};
        
        % get subgraph data
        if strcmp(data_dir(end-5:end-1),'param')
            subset = readNPY([data_dir, subj, '/', sens, 'wpli_', f, '_subset.npy']);
            coeff = readNPY([data_dir, subj, '/',sens, 'wpli_', f, '_coeff.npy']);
        else
            subset = readNPY([data_dir, subj, '/', sens, '/wpli_', f, '_subset.npy']);
            coeff = readNPY([data_dir, subj, '/',sens, '/wpli_', f, '_coeff.npy']);
        end
        
        % remove noise SG
        idx = noise_sg{k,i};
        coeff = coeff(~idx,:);
        subset = subset(~idx,:);
        
        b_exp = subset(:,end);
        [~,bSG] = max(b_exp);
        [~, nzSG] = min(nonzeros((b_exp))); % smallest nonzero - this is how we will opporationalize "low"
        nSG = size(subset,1);
        
        % if you actualy want to look at 0s
        if sum(b_exp == 0) <= 1
            [~,nbSG] = min(b_exp);
        else
            nbSG = find(b_exp == 0);
        end
        nZero = numel(nbSG);
        
        % get gramian
        % scale to be stable
        high_mat = get_sg_matrix(nNode, subset(bSG,:));
        high_mat = high_mat./eigs(high_mat,1) - eye(nNode).*1.001;
        low_mat = get_sg_matrix(nNode, subset(nzSG,:));
        low_mat = low_mat./eigs(low_mat,1) - eye(nNode).*1.001;
        zero_mat = zeros(nNode, nNode, nZero);
        for j = 1:nZero
            zero_mat(:,:,j) = get_sg_matrix(nNode, subset(nbSG,:));
            zero_mat(:,:,j) = zero_mat(:,:,j)./eigs(zero_mat(:,:,j),1) - eye(nNode).*1.001;
        end
        
        % get largest eigenvector of grammian
        [cont_h_vect, h_val, ~, cont_h_vect2] = easy_state(high_mat,diag(B_control),eye(nNode),zeros(nNode));
        [cont_l_vect, l_val, ~, cont_l_vect2] = easy_state(low_mat,diag(B_control),eye(nNode),zeros(nNode));
        cont_z_ev2_all = zeros(nNode, nZero);
        for j = 1:nZero
            [~, ~, ~, cont_z_ev2] = easy_state(zero_mat(:,:,j),diag(B_control),eye(nNode),zeros(nNode));
            cont_z_ev2_all(:,j) = cont_z_ev2;
        end
        cont_zero_states_ev2(:,i,k) = mean(cont_z_ev2_all,2);
        
        cont_high_states(:,i,k) = cont_h_vect;
        cont_low_states(:,i,k) = cont_l_vect;
        cont_high_states_ev2(:,i,k) = cont_h_vect2;
        cont_low_states_ev2(:,i,k) = cont_l_vect2;
    end
end

%% visualize


cfg.layout = [top_dir, 'layouts/neuromag306cmb.lay'];
fid = fopen([top_dir, 'layouts/neuromag306cmb.txt'], 'r');

for i = 1:numel(bands)
    plot_data.powspctrm = mean(cont_high_states(:,:,i),2);
    plot_data.label = cmb_labels;
    plot_data.dimord = 'chan_freq';
    plot_data.freq = mean(freqs(i,:));
    plot_data.cfg = [];
    figure(1); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([0.06,.13])
    saveas(gca, [img_dir, bands{i}, '_cont_avg_high_state.png'], 'png')
    
    plot_data.powspctrm = mean(cont_low_states(:,:,i),2);
    figure(1); clf
    ft_topoplotER(cfg,plot_data); colorbar; caxis([0.06,.13])
    saveas(gca, [img_dir, bands{i}, '_cont_avg_low_state.png'], 'png')
    
    % ev2
    plot_data.powspctrm = mean(cont_high_states_ev2(:,:,i),2);
    figure(3);
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_cont_high_ev2_state.png'], 'png')
    
    % ev2
    plot_data.powspctrm = mean(cont_low_states_ev2(:,:,i),2);
    figure(4); colorbar
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_cont_low_ev2_state.png'], 'png')
    
    % ev2
    plot_data.powspctrm = mean(cont_zero_states_ev2(:,:,i),2);
    figure(5); colorbar
    ft_topoplotER(cfg,plot_data); colorbar; caxis([-.1,.1])
    saveas(gca, [img_dir, bands{i}, '_cont_zero_ev2_state.png'], 'png')
end


%% Categorize by lobe


cont_h_region = [];
cont_l_region = [];
cont_h_region2 = [];
cont_l_region2 = [];
cont_z_region2 = [];
region_ord = {};
band_ord = {};

cnt = 1;
for i = 1:numel(regions)
    for j = 1:numel(bands)
        load([top_dir, 'montages/', regions{i}, '_idx.mat'])
        idx = logical(idx);
        % get the mean edge between a lobes (total edges/number of edges), divided by
        % the total edges
        
        % stupid frmatting thing for R
        for k = 0:19
            region_ord{cnt+k} = regions{i};
            band_ord{cnt+k} = bands{j};
        end
        cont_h_region = [cont_h_region, mean(cont_high_states(idx,:,j))];
        cont_l_region = [cont_l_region, mean(cont_low_states(idx,:,j))];
        cont_h_region2 = [cont_h_region2, mean(cont_high_states_ev2(idx,:,j))];
        cont_l_region2 = [cont_l_region2, mean(cont_low_states_ev2(idx,:,j))];
        cont_z_region2 = [cont_z_region2, mean(cont_zero_states_ev2(idx,:,j))];
        
        cnt = cnt + nSubj;
    end
end

save([R_dir, 'grad/cont_control_state.mat'], 'region_ord', 'band_ord', 'cont_h_region', 'cont_l_region', 'cont_h_region2', 'cont_l_region2', 'cont_z_region2')